## 3. [운영체제] 프로세스의 생성과정을 설명해보아라

> 프로세스는 OS가 프로그램을 메모리로 가져와서 실행할 때 새로 생성됩니다.
>
> 하지만 보통은 완전히 새로 생성되기 보다 fork()라는 시스템 콜을 사용하여 기존의 프로세스를 복사합니다. 부모 프로세스의 자원을 상속받아서 효율적이고 빠르게 생성되기 때문입니다.
>
> 한편, exec() 라는 시스템 콜을 사용하여 복사한 프로세스의 내용을 새롭게 바꾸기도 합니다. 프로세스의 구조체를 재활용하면서 코드 영역만 새롭게 바꾸면 되어서 편리하기 때문입니다.

### 0. (이해를 돕기 위한) 프로세스의 구조

> 코드 / 데이터 / 스택 영역으로 구성됨

- 핵심 개념 복습
  - 프로그램: 저장장치에 저장되어있는 정적인 상태의 파일(ex. 워드프로세서 등)
  - 프로세스: 프로그램이 실행되기 위해 메모리에 올라온 상태. 실행에 필요한 자원(주소공간, CPU 등)을 운영체제로부터 할당 받음!

- 코드 영역: 프로그래머가 작성한 프로그램의 코드가 들어있음
- 데이터 영역: 코드가 실행되면서 사용하는 변수, 파일 등 각종 데이터를 모아놓음
- 스택 영역: 운영체제가 프로세스를 실행하기 위해 부수적으로 필요한 데이터를 모아놓음



### 1. 프로세스의 생성

- **언제 프로세스가 생성되나?** 프로그램을 실행할 때 프로세스가 새로 생성됨
  - 사용자가 프로그램 실행 `->` 운영체제가 프로그램을 메모리로 가져옴 `->` 코드 영역에 넣고 *프로세스 제어 블록* 생성 `->` 데이터 영역, 스택 영역 확보한 후 프로세스 실행 `->` 프로세스 생성 응애!👶
- **하지만,** 프로세스는 보통 완전히 새로 생성되기 보다 **기존의 프로세스를 복사**해서 생성됨
- **Why is 복사 better than 새로 생성?**
  1. 프로세스의 생성 속도가 빠름: 기존 메모리에서 복사하기 때문에
  2. 추가 작업 없이 자원 상속 가능: 기존(부모) 프로세스가 사용하던 모든 자원을 자식이 상속 가능
  3. 효율적인 시스템 관리 가능
     - 원래 프로세스를 종료하면 프로세스가 사용하던 메모리 영역, 파일, 하드웨어를 정리해야 함
     - 하지만 자식 프로세스를 종료하면 이러한 정리 작업을 부모가 대신 해줌으로써 효율적인 관리 가능



### 2. 프로세스의 복사 - `fork()`

- **왜 복사가 더 좋은지는 알겠어, 근데 어떻게 복사되는데?** `fork()` *시스템 콜* 을 통해!
- **fork() 시스템 콜이란?**
  - 실행 중인 프로세스를 복사하는 함수
  - `fork()` 함수를 호출하면 *프로세스 제어 블록(PCB)* 을 포함한 부모 프로세스의 대부분이 자식 프로세스에 복사됨
  - But 프로세스 제어 블록의 내용 중 변경되는 세 가지
    1. 프로세스 구분자(`PID`) : 사람의 주민등록번호와 비슷한 개념. 자식이 아무리 부모를 상속받아도 어쨌든 부모와 자식은 각각 다른 프로세스니까!
    2. 메모리 관련 정보: 부모와 자식이 차지하고 있는 메모리의 위치가 다르니까
    3. 부모 프로세스 구분자(`PPID`) 와 자식 프로세스 구분자(`CPID`): 일종의 가족관계증명서!
       - 자식 프로세스의 `PPID`는 부모의 `PID` 
       - 자식 프로세스의 자식은 없다고 가정한다면 자식 프로세스의 `CPID` 는 `-1` 임
       - 그렇다면 부모 프로세스의 `CPID` 는? 자식 프로세스의 `PID` !



📚 **용어 설명** 

- **시스템 콜**: 프로그램이 실행되기 위해서는 운영체제의 도움을 받아야 함. 따라서 각 프로그램들은 운영체제의 도움을 받기 위해 커널 함수를 호출하는데 이게 바로 시스템 콜!
  - 💾`(프로그램): 운영체제님 저 실행될 수 있게 도와주세요...!` 
- **프로세스 제어 블록(`PCB: Process Control Block`)**: 각각의 프로세스가 갖고 있는 정보
  1. 운영체제가 관리할 때 사용하는 정보: 프로세스의 상태, 프로세스의 구분자, 우선순위 등
  2. CPU 수행과 관련된 하드웨어 정보
  3. 메모리 관련 정보(코드/데이터/스택의 위치 정보)
  4. 파일 관련 정보



### 3. 프로세스의 전환 - `exec()`

>  쉽게 말하자면 복사한 프로세스에 새로운 내용을 덮어버리는 것

- **exec() 시스템 콜이란?**
  - 프로세스는 그대로 둔 채 내용만 바꾸는 시스템 콜
- **쓰는 이유?** 프로세스의 구조체를 재활용 하기 위해 
  - 부모 프로세스의 PCB 등을 복사된 것을 사용할 수 있어 편리
  - 코드 영역만 새롭게 가져오면 되기 때문에 운영체제의 작업이 수월해짐
    - 👨`(부모 프로세스): PCB 등등은 내가 줄게, 새로운 코드는 너가 직접 써!`
- **exec() 시스템 콜의 동작 과정**
  1. `exec()` 시스템 콜
  2. 코드 영역의 기존 내용 지우고 새로운 코드로 바뀜
  3. 데이터 영역이 새로운 변수로 채워지고 스택 영역 리셋
  4. `PCB` 중 `PID/PPID/CPID` 는 변하지 않지만 *프로그램 카운터* 값을 비롯한 각종 레지스터, 사용한 파일 정보 리셋

📚 **용어 설명**

- **프로그램 카운터** : 책갈피랑 비슷한 개념! 프로그램 코드를 어디까지 읽었는지 기록해둔 것
  - 프로그램은 각자의 코드를 가지고 있음
  - 프로그램을 실행하는 것은 CPU기 때문에 CPU를 원하는 프로그램은 아주 많음
  - 따라서 한 프로그램의 코드를 읽다가도 다른 프로그램의 코드로 넘어가는 경우가 흔함
  - 따라서 해당 프로그램이 다시 CPU를 잡을 때를 대비하기 위해 프로그램의 코드를 어디까지 읽었는지 기록해두어야 하는데 그게 바로 프로그램 카운터!



출처

- 반효경 교수 운영체제 강의 Chapter2, 3, 4
- 책 <쉽게 배우는 운영체제, 한빛아카데미>